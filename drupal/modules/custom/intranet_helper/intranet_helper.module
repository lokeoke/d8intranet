<?php

use Symfony\Component\HttpFoundation\RedirectResponse;
use Drupal\user\Entity\User;

/**
 * Implements hook_user_login().
 */
function intranet_helper_user_login($account) {
  if (Drupal::request()->query->get('redirect')) {
    global $base_root;

    // Set redirect headers to Drupal response.
    $response = new RedirectResponse($base_root);
    $response->send();
  }
}

/**
 * Implements hook_user_logout().
 */
function intranet_helper_user_logout($account) {
  // Check out user.
  \Drupal::service('intranet_helper.services.api')->checkUserOut(time(), $account->id());

  if (Drupal::request()->query->get('redirect')) {
    global $base_root;

    // Set redirect headers to Drupal response.
    $response = new RedirectResponse($base_root);
    $response->send();
  }
}


/**
 * Implements hook_cron().
 */
function intranet_helper_cron() {
  $config = \Drupal::configFactory()->getEditable('intranet_helper.settings');
  $current_day_number = (int) date('j', time());
  $last_cron_day_number = (int) date('j', $config->get('interval'));
  $days_diff = $current_day_number - $last_cron_day_number;

  if ($days_diff) {
    $intranetApi = \Drupal::service('intranet_helper.services.api');
    $users = $intranetApi->getCheckedInUsers(FALSE);

    foreach ($users as $user) {
      $uid = (int) $user['uid'];

      if (!in_array($uid, array(0, 1))) {
        $intranetApi->checkUserOut(time(), $uid);
      }
    }

    $config->set('interval', time())->save();
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * Adds 'Save & edit' button to user edit form
 */
function intranet_helper_form_user_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {
  $form['actions']['save_edit'] = array(
    '#type' => 'submit',
    '#value' => t('Save & edit'),
    '#submit' => array('intranet_helper_user_save_and_edit'),
  );
}

/**
 * Submit callback for 'Save & edit' button to user edit form.
 *
 * Save user without redirect.
 *
 * @param array $form
 *   User edit form.
 * @param \Drupal\Core\Form\FormStateInterface $form_state
 *   User edit form state object.
 */
function intranet_helper_user_save_and_edit(array $form, \Drupal\Core\Form\FormStateInterface $form_state) {
  /**
   * @var \Drupal\Core\Entity\EntityForm $account_entity_form
   */
  $account_entity_form = $form_state->getFormObject();
  $account_entity = $account_entity_form->getEntity();
  $account_entity->save();
  $form_state->setValue('uid', $account_entity->id());
  $form_state->disableRedirect(TRUE);

  drupal_set_message(t('The changes have been saved.'));
}
